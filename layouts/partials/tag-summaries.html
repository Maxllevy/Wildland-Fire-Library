{{- define "formatList" -}}
    {{- $list := . -}}
    {{- $len := len $list -}}
    {{- if eq $len 1 -}}{{index $list 0}}
    {{- else if eq $len 2 -}}{{index $list 0}} and {{index $list 1}}
    {{- else -}}{{delimit (initial $list) ", " }}, and {{last $list}}
    {{- end -}}
{{- end -}}

{{- define "analyzeContent" -}}
    {{- $keywords := slice -}}
    {{- range . -}}
        {{- $content := lower .Content -}}
        {{- range $pattern, $keyword := $.patterns -}}
            {{- if findRE $pattern $content -}}
                {{- $keywords = $keywords | append $keyword -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
    {{- return (uniq $keywords) -}}
{{- end -}}

{{- $patterns := dict -}}
{{- $summary := "" -}}

{{- if eq (lower .mainCategory) "landowner" -}}
    {{- if eq (lower .subCategory) "fire_preparedness" -}}
        {{- $patterns = dict "evacuation|route|emergency|exit" "evacuation planning" "communication|alert|notification" "emergency alerts" "checklist|preparation|pack|kit" "emergency kits" -}}
        {{- $summary = "Resources for emergency preparedness" -}}
    {{- else if eq (lower .subCategory) "property_management" -}}
        {{- $patterns = dict "defensible space|clearing|vegetation" "defensible space" "construction|material|building" "fire-resistant construction" "maintenance|upkeep|regular" "maintenance guidelines" -}}
        {{- $summary = "Resources for" -}}
    {{- else if eq (lower .subCategory) "grants" -}}
        {{- $patterns = dict "federal|government|agency" "federal grants" "state|local|county" "state programs" "non.?profit|foundation|private" "private funding" -}}
        {{- $summary = "Available funding through" -}}
    {{- end -}}
{{- else if eq (lower .mainCategory) "student" -}}
    {{- if eq (lower .subCategory) "academic_assistance" -}}
        {{- $patterns = dict "research|lab|scientific" "research" "field|practical|hands.?on" "field work" "career|professional|development" "career development" -}}
        {{- $summary = "Connect with mentors in" -}}
    {{- else if eq (lower .lastElement) "jobs" -}}
        {{- $patterns = dict "fire ecology|fireecology|afe" "fire ecology" "usajobs|federal|government|interior" "federal" "university|college|academic" "academic" "environment|conservation" "environmental" -}}
        {{- $summary = "Access job boards specializing in" -}}
    {{- end -}}
{{- else if eq (lower .mainCategory) "researcher" -}}
    {{- $patterns = dict "model|prediction|forecast" "climate modeling" "data|measurement|observation" "climate data" "impact|effect|influence" "impact analysis" -}}
    {{- $summary = "Access resources for" -}}
{{- end -}}

{{- $keywords := partial "analyzeContent" (dict "context" .context.Pages "patterns" $patterns) -}}
{{- if gt (len $keywords) 0 -}}
    {{$summary}} {{ template "formatList" (first 3 $keywords) }}.
{{- else -}}
    {{- if eq (lower .mainCategory) "landowner" -}}Essential resources for fire preparedness and property management.
    {{- else if eq (lower .mainCategory) "student" -}}Find opportunities in fire ecology and management.
    {{- else if eq (lower .mainCategory) "researcher" -}}Explore climate research resources and data.
    {{- end -}}
{{- end -}}